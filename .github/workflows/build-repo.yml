name: Build and Sign Debian Repository

on:
  push:
    branches: [main]
    paths:
      - 'pool/**'
  workflow_dispatch:

env:
  DIST: stable
  COMPONENT: main
  ARCH: amd64

jobs:
  setup-gpg:
    runs-on: ubuntu-latest
    outputs:
      gpg-key-id: ${{ steps.setup-keys.outputs.key-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GPG keys
        id: setup-keys
        run: |
          if [ -f "KEY.gpg" ]; then
            echo "✅ Using existing GPG key"
            gpg --import KEY.gpg
            KEY_ID=$(gpg --list-keys --with-colons | grep '^fpr:' | head -1 | cut -d':' -f10)
            echo "key-id=$KEY_ID" >> $GITHUB_OUTPUT
          else
            echo "🔐 Generating new GPG key..."
            echo -e "Key-Type: RSA\nKey-Length: 4096\nName-Real: NAS Repository\nName-Email: nas-repo@users.noreply.github.com\nExpire-Date: 0" > gpg-input
            echo "%no-protection" >> gpg-input
            echo "%commit" >> gpg-input
            
            gpg --batch --generate-key gpg-input
            KEY_ID=$(gpg --list-keys --with-colons | grep '^fpr:' | head -1 | cut -d':' -f10)
            gpg --armor --export "$KEY_ID" > KEY.gpg
            echo "key-id=$KEY_ID" >> $GITHUB_OUTPUT
            echo "✅ Generated new GPG key: $KEY_ID"
            rm gpg-input
          fi

  build-repository:
    runs-on: ubuntu-latest
    needs: setup-gpg
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro gnupg apt-utils

      - name: Import GPG key
        run: |
          gpg --import KEY.gpg
          KEY_FPR=$(gpg --list-keys --with-colons | grep '^fpr:' | head -1 | cut -d':' -f10)
          echo "$KEY_FPR:6:" | gpg --import-ownertrust

      - name: Setup repository structure
        run: |
          mkdir -p conf
          
          # TWORZENIE PLIKU distributions BEZ HEREDOC - POPRAWNIE
          echo "Origin: NAS Repository" > conf/distributions
          echo "Label: NAS Debian Repository" >> conf/distributions
          echo "Codename: ${{ env.DIST }}" >> conf/distributions
          echo "Architectures: ${{ env.ARCH }}" >> conf/distributions
          echo "Components: ${{ env.COMPONENT }}" >> conf/distributions
          echo "Description: Repository for NAS applications" >> conf/distributions
          echo "SignWith: ${{ needs.setup-gpg.outputs.gpg-key-id }}" >> conf/distributions
          
          # TWORZENIE PLIKU options BEZ HEREDOC
          echo "basedir $(pwd)" > conf/options

      - name: Find and add all packages
        run: |
          find pool -name "*.deb" | while read deb_file; do
            echo "📦 Adding package: $deb_file"
            reprepro includedeb ${{ env.DIST }} "$deb_file"
          done

      - name: Export and sign repository
        run: |
          reprepro export ${{ env.DIST }}
          cd dists/${{ env.DIST }}
          gpg --verify Release.gpg Release

      - name: List all packages in repository
        run: |
          reprepro list ${{ env.DIST }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          keep_files: true

      - name: Verify deployment
        run: |
          echo "✅ Repository deployed to GitHub Pages"
          echo "📦 Available at: https://${{ github.repository_owner }}.github.io/${{ github.repository }}/"
